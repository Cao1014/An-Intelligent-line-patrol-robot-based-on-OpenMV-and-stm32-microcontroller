/* mbed Microcontroller Library
 * Copyright (c) 2019 ARM Limited
 * SPDX-License-Identifier: Apache-2.0
 */

#include "mbed.h"

using namespace std::chrono;

DigitalOut trigger_1(D2);
DigitalIn  echo_1(D3);

DigitalOut trigger_2(D4);
DigitalIn  echo_2(D5);

BufferedSerial mbed_uart(D1, D0, 9600); // tx, rx


int measured_distance_1 = 0;
int measured_distance_2 = 0;

int correction = 0;

int ultrasonic_output;

//char *c;

Timer sonar;

int main()
{
    sonar.reset();
// measure actual software polling timer delays
// delay used later in time correction
// start timer
    sonar.start();
// min software polling delay to read echo pin
    while (echo_1==2) {};

// stop timer
    sonar.stop();
// read timer
    correction = duration_cast<microseconds>(sonar.elapsed_time()).count();
    printf("Approximate software overhead timer delay is %d uS\n\r",correction);

//Loop to read Sonar distance values, scale, and print
    while(1) {
// trigger sonar to send a ping
        trigger_1 = 1;

        sonar.reset();
        wait_us(10.0);
        trigger_1 = 0;

//wait for echo high
        while (echo_1==0) {};

//echo high, so start timer
        sonar.start();
//wait for echo low
        while (echo_1==1) {};
//stop timer and read value
        sonar.stop();
//subtract software overhead timer delay and scale to cm
        if ((duration_cast<microseconds>(sonar.elapsed_time()).count()-correction)>= 2353) //40cm*2/100/340*1000*1000=2353 (us)
        {
            measured_distance_1 = 40;
        }
        else if ((duration_cast<microseconds>(sonar.elapsed_time()).count()-correction)<= 118) //2cm*2/100/340*1000*1000=118 (us)
        {
            measured_distance_1 = 2;
        }
        else
        {
        measured_distance_1 = (duration_cast<microseconds>(sonar.elapsed_time()).count()-correction)/58.0;
        }

        
//////////////////////////////////////////////////////////////////////
        // trigger sonar to send a ping
        trigger_2 = 1;

        sonar.reset();
        wait_us(10.0);
        trigger_2 = 0;

//wait for echo high
        while (echo_2==0) {};

//echo high, so start timer
        sonar.start();
//wait for echo low
        while (echo_2==1) {};
//stop timer and read value
        sonar.stop();
//subtract software overhead timer delay and scale to cm
        if ((duration_cast<microseconds>(sonar.elapsed_time()).count()-correction)>= 2353) //40cm*2/100/340*1000*1000=2353 (us)
        {
            measured_distance_2 = 40;
        }
        else if ((duration_cast<microseconds>(sonar.elapsed_time()).count()-correction)<= 118) //2cm*2/100/340*1000*1000=118 (us)
        {
            measured_distance_2 = 2;
        }
        else
        {
        measured_distance_2 = (duration_cast<microseconds>(sonar.elapsed_time()).count()-correction)/58.0;
        }

        printf(" measured_distance_1 is: %d cm \n\r",measured_distance_1);
//wait so that any echo(s) return before sending another ping
        printf(" measured_distance_2 is: %d cm \n\r",measured_distance_2);
//wait so that any echo(s) return before sending another ping

        ultrasonic_output = measured_distance_2 - measured_distance_1;
        
        /*char buffer[32];
        sprintf(buffer, "%d\r\n", ultrasonic_output);  // 将整数转换为字符串并添加换行符
        mbed_uart.write(buffer, sizeof(buffer));       // 发送字符串
        printf("%c \n",buffer);*/
        mbed_uart.write(&ultrasonic_output, sizeof(ultrasonic_output));
        // 发送分隔符，例如换行符
        char delimiter = '\n';
        mbed_uart.write(&delimiter, sizeof(delimiter));

        /*char buffer[4];
        snprintf(buffer, sizeof(buffer), "%d", ultrasonic_output);
        mbed_uart.write(&buffer, sizeof(buffer));*/
        
        //mbed_uart.read(c, sizeof(c));
        //printf("%c \n", *c);

        printf(" ultrasonic_output is: %d cm \n\r",ultrasonic_output);


        printf("\n");
        thread_sleep_for(10);
        
        
    }
}